<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>CyclOSM vector</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css" rel="stylesheet" />
    <script src='https://unpkg.com/mapbox-gl-inspect@1.3.1/dist/mapbox-gl-inspect.min.js'></script>
    <link href='https://unpkg.com/mapbox-gl-inspect@1.3.1/dist/mapbox-gl-inspect.css' rel='stylesheet' />
    <style>
      body { margin: 0; padding: 0; }
      #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      mapboxgl.accessToken = 'pk.eyJ1IjoiZnJhbmNvaXMybWV0eiIsImEiOiJjam92dHk0ZHExbGU4M3BvOTFvdmVlcDIyIn0.r7X8EIJqu7AgPHHd7zKajQ';

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v10',
        center: [2.3601072, 48.876853],
        zoom: 18,
        hash: true
      });
      const loadImage = (name) => {
        const img = new Image();
        img.src = `${name}.svg`;
        img.addEventListener('load', () => {
          map.addImage(name, img);
        });
      };
      loadImage('oneway');
      loadImage('oneway-reverse');

      map.on('load', () => {
        map.addControl(new MapboxInspect());
        map.addSource('cyclo', {
          type: 'vector',
          url: '/cyclo.json'
        });
        const color = [
          "case",
          ["get", "temporary"], "orange",
          "green"
        ];
        const offset = 5;
        const width = 2;
        const notShared = ["track", "shoulder"]
        const shared = ["lane", "busway", "share_busway", "shared_lane"];
        const opposite = ["opposite"];
        map.addLayer({
          source: 'cyclo',
          id: "left-shared",
          "type": "line",
          "source-layer": "roads",
          "filter": ["all", ["has", "left"], ["in", "left", ...shared]],
          "paint": {
            "line-dasharray": [4, 1],
            "line-offset": -offset,
            "line-color": color,
            "line-width": width
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "left-noshared",
          "type": "line",
          "source-layer": "roads",
          "filter": ["all", ["has", "left"], ["in", "left", ...notShared]],
          "paint": {
            "line-offset": -offset,
            "line-color": color,
            "line-width": width
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "right-shared",
          "type": "line",
          "source-layer": "roads",
          "filter": ["all", ["has", "right"], ["in", "right", ...shared]],
          "paint": {
            "line-dasharray": [4, 1],
            "line-offset": offset,
            "line-color": color,
            "line-width": width
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "right-noshared",
          "type": "line",
          "source-layer": "roads",
          "filter": ["all", ["has", "right"], ["in", "right", ...notShared]],
          "paint": {
            "line-offset": offset,
            "line-color": color,
            "line-width": width
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "cycleway",
          "type": "line",
          "source-layer": "roads",
          "filter": ["all", ["!has", "right"], ["!has", "left"]],
          "paint": {
            "line-color": color,
            "line-width": width
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "cycleway-oneway",
          "type": "line",
          "source-layer": "roads",
          "filter": ["all", ["!has", "right"], ["!has", "left"], ["in", "oneway", "yes", "-1"]],
          "paint": {
"line-pattern": [
              "case",
              ["==", ["get", "oneway"], "-1"], "oneway-reverse",
              "oneway"
            ],
            "line-width": width * 4
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "poi-circle",
          "type": "circle",
          "source-layer": "poi",
          "paint": {
            "circle-color": "green",
            "circle-radius": 4
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "poi-capacity",
          "type": "symbol",
          "source-layer": "poi",
          "minzoom": 17,
          "layout": {
            "text-field": ["get", "capacity"],
            "text-size": 10,
            "text-offset": [0, 1]
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "left-oneway",
          "type": "line",
          "source-layer": "roads",
          "filter": ["all", ["has", "left"], ["in", "left", ...shared, ...notShared], ["in", "left_oneway", "yes", "-1"]],
          "paint": {
            "line-pattern": [
              "case",
              ["==", ["get", "left_oneway"], "-1"], "oneway-reverse",
              "oneway"
            ],
            "line-offset": -offset,
            "line-width": width * 4
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "right-oneway",
          "type": "line",
          "source-layer": "roads",
          "filter": ["all", ["has", "right"], ["in", "right", ...shared, ...notShared], ["in", "right_oneway", "yes", "-1"]],
          "paint": {
            "line-pattern": [
              "case",
              ["==", ["get", "right_oneway"], "-1"], "oneway-reverse",
              "oneway"
            ],
            "line-offset": offset,
            "line-width": width * 4
          }
        });
        map.addLayer({
          source: 'cyclo',
          id: "cyclo-opposite",
          "type": "line",
          "source-layer": "roads",
          "filter": ["any", ["in", "right", ...opposite], ["in", "left", ...opposite]],
          "paint": {
            "line-pattern": "oneway-reverse",
            "line-width": width * 3
          }
        });
      });
    </script>
  </body>
</html>
