# t-rex configuration

[service.mvt]
viewer = false

[[datasource]]
dbconn = "postgresql://postgres:postgres@postgres/postgres"
name = "dbconn"
default = true

[grid]
predefined = "web_mercator"


[[tileset]]
name = "cyclo"
extent = [-1.97743, 47.35058, 4.27231, 49.60482]
[[tileset.layer]]
name = "roads"
geometry_field = "way"
geometry_type = "LINESTRING"
srid = 3857
buffer_size = 0
#make_valid = true
simplify = true
query_limit = 1000
[[tileset.layer.query]]
sql = """SELECT
          way,
          CASE
            WHEN highway='raceway' THEN 'track'  -- render raceways as tracks
            WHEN highway='road' THEN 'residential'  -- render "road" as residential
            WHEN highway='footway' AND (bicycle='yes' OR bicycle='designated') THEN 'path'
            WHEN highway='bridleway' AND (bicycle='yes' OR bicycle='designated') THEN 'path'
            WHEN highway!='bus_guideway' THEN highway
            ELSE NULL
          END AS type,
          access,
          CASE
            WHEN tags->'cyclestreet' IN ('yes') THEN 'yes'
            WHEN tags->'bicycle_road' IN ('yes') THEN 'yes'
            ELSE 'no'
          END AS cyclestreet,
          CASE
            WHEN tags->'cycleway:left' IN ('track', 'opposite_track') THEN 'track'
            WHEN tags->'cycleway:left' IN ('lane', 'opposite_lane') THEN 'lane'
            WHEN tags->'cycleway:left' IN ('share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane') THEN 'busway'
            WHEN tags->'cycleway:both' IN ('track', 'opposite_track') THEN 'track'
            WHEN tags->'cycleway:both' IN ('lane', 'opposite_lane') THEN 'lane'
            WHEN tags->'cycleway:both' IN ('share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane') THEN 'busway'
            WHEN tags->'cycleway' IN ('track', 'opposite_track') THEN 'track'
            WHEN tags->'cycleway' IN ('lane', 'opposite_lane') THEN 'lane'
            WHEN tags->'cycleway' IN ('share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane') THEN 'busway'
            WHEN tags->'cycleway' IN ('opposite') THEN 'opposite'
            WHEN tags->'cycleway:left' IN ('opposite') THEN 'opposite'
            WHEN tags->'cycleway:both' IN ('opposite') THEN 'opposite'
            ELSE NULL
          END AS left,
          CASE
            WHEN tags->'cycleway:right' IN ('track', 'opposite_track') THEN 'track'
            WHEN tags->'cycleway:right' IN ('lane', 'opposite_lane') THEN 'lane'
            WHEN tags->'cycleway:right' IN ('share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane') THEN 'busway'
            WHEN tags->'cycleway:both' IN ('track', 'opposite_track') THEN 'track'
            WHEN tags->'cycleway:both' IN ('lane', 'opposite_lane') THEN 'lane'
            WHEN tags->'cycleway:both' IN ('share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane') THEN 'busway'
            WHEN tags->'cycleway' IN ('track', 'opposite_track') THEN 'track'
            WHEN tags->'cycleway' IN ('lane', 'opposite_lane') THEN 'lane'
            WHEN tags->'cycleway' IN ('share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane') THEN 'busway'
            WHEN tags->'cycleway' IN ('opposite') THEN 'opposite'
            WHEN tags->'cycleway:right' IN ('opposite') THEN 'opposite'
            WHEN tags->'cycleway:both' IN ('opposite') THEN 'opposite'
            ELSE NULL
          END AS right,
          CASE
            WHEN tags->'cycleway:left:oneway' IS NOT NULL THEN tags->'cycleway:left:oneway'
            WHEN tags->'cycleway:left' IN ('opposite_lane', 'opposite_track', 'opposite_share_busway') THEN '-1'
            WHEN tags->'cycleway' IN ('opposite_lane', 'opposite_track', 'opposite_share_busway') THEN '-1'
            WHEN oneway IN ('yes', '-1') THEN oneway
            ELSE '-1'
          END AS left_oneway,
          CASE
            WHEN tags->'cycleway:right:oneway' IS NOT NULL THEN tags->'cycleway:right:oneway'
            WHEN tags->'cycleway:right' IN ('opposite_lane', 'opposite_track', 'opposite_share_busway') THEN '-1'
            WHEN tags->'cycleway' IN ('opposite_lane', 'opposite_track', 'opposite_share_busway') THEN '-1'
            WHEN oneway IN ('yes', '-1') THEN oneway
            ELSE 'yes'
          END AS right_oneway,
          CASE
            WHEN tags->'segregated' IN ('yes') THEN 'yes'
            ELSE 'no'
          END AS segregated,
          CASE
            WHEN tags->'oneway:bicycle' IN ('yes', '-1') THEN tags->'oneway:bicycle'
            WHEN oneway IN ('yes', '-1') THEN oneway
            ELSE 'no'
          END AS oneway,
          COALESCE(
            tags->'ramp:bicycle',
            tags->'ramp:stroller',
            tags->'ramp:wheelchair',
            tags->'ramp:luggage'
          ) AS has_ramp,
          CASE
            WHEN tags->'indoor' IS NULL OR tags->'indoor' = 'no' THEN NULL
            ELSE TRUE
          END as indoor,
          CASE
            WHEN tunnel IS NULL OR tunnel = 'no' THEN NULL
            ELSE TRUE
          END as tunnel,
          CASE
            WHEN bridge IS NULL OR bridge = 'no' THEN NULL
            ELSE TRUE
          END as bridge,
          CASE
            WHEN covered IS NULL OR covered = 'no' THEN NULL
            ELSE TRUE
          END as covered,
          CASE
            WHEN tags->'description:covid19' IS NOT NULL THEN TRUE
            ELSE FALSE
          END as temporary
        FROM planet_osm_line
        WHERE (
                highway = 'cycleway'
                OR tags->'cycleway' in ('track', 'lane', 'opposite', 'opposite_lane', 'opposite_track', 'share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane')
                OR tags->'cycleway:right' in ('track', 'lane', 'opposite', 'opposite_lane', 'opposite_track', 'share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane')
                OR tags->'cycleway:left' in ('track', 'lane', 'opposite', 'opposite_lane', 'opposite_track', 'share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane')
                OR tags->'cycleway:both' in ('track', 'lane', 'opposite', 'opposite_lane', 'opposite_track', 'share_busway', 'opposite_share_busway', 'shoulder', 'shared_lane')
                OR COALESCE(tags->'cycleway:right:oneway', tags->'cycleway:left:oneway') IS NOT NULL
                OR tags->'cyclestreet' = 'yes'
                OR tags->'bicycle_road' = 'yes'
                OR tags->'segregated' = 'yes'
              )
              AND way && !bbox!
     """
[[tileset.layer]]
name = "poi"
geometry_field = "way"
geometry_type = "POINT"
srid = 3857
buffer_size = 0
#make_valid = true
simplify = true
query_limit = 4000
[[tileset.layer.query]]
sql = """SELECT
          way,
          name,
          access,
          bicycle,
          covered,
          COALESCE(
            'amenity_' || CASE WHEN amenity IN ('bicycle_parking', 'motorcycle_parking') THEN amenity ELSE NULL END
          ) AS feature,
          CASE
            WHEN tags->'capacity'~E'^\\\\d+$' THEN (tags->'capacity')::integer
            ELSE NULL
          END AS capacity,
          tags->'bicycle_parking' as bicycle_parking
        FROM (
          SELECT
            way,
            name,
            access,
            bicycle,
            covered,
            amenity,
            tags
          FROM planet_osm_point
          WHERE way && !bbox!

          UNION ALL

          SELECT
            ST_Centroid(way) AS way,
            name,
            access,
            bicycle,
            covered,
            amenity,
            tags
           FROM planet_osm_polygon
           WHERE way && !bbox!
        ) AS poi_union
        WHERE
          (
            amenity IN ('bicycle_parking')
            OR (amenity='motorcycle_parking' AND (bicycle='yes' OR bicycle='designated'))
          )
"""

[webserver]
# Bind address. Use 0.0.0.0 to listen on all adresses.
bind = "0.0.0.0"
port = 6767

[[webserver.static]]
dir = "/data/static"
path = "/static"
